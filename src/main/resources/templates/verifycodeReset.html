<!doctype html>
<html lang="en" dir="ltr" xmlns:th="http://thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<meta name="viewport"
		content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	
	<link rel="icon" th:href="@{/assets/images/favicon.png}" type="image/x-icon" />

	<title>SK PMA - Verify Code</title>
	
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<!-- Bootstrap Core and vandor -->
	<link rel="stylesheet" th:href="@{/assets/plugins/bootstrap/css/bootstrap.min.css}" />

	<!-- Core css -->
	<link rel="stylesheet" th:href="@{/assets/css/main.css}" />
	<link rel="stylesheet" th:href="@{/assets/css/theme1.css}" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/luxon/3.5.0/luxon.min.js" integrity="sha512-SN7iwxiJt9nFKiLayg3NjLItXPwRfBr4SQSIugMeBFrD4lIFJe1Z/exkTZYAg3Ul+AfZEGws2PQ+xSoaWfxRQQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

</head>

<body class="font-montserrat">

	<div class="auth">
		<div class="auth_left">
			<div class="card">
				<div class="text-center mb-3">
					<a class="header-brand" href="index.html">
						<img th:src="@{/assets/images/sklogo.svg}" class="img-fluid" alt="" /></a>
				</div>
				<div class="card-body">
					<div class="alert alert-danger" id="serverError" style="text-align: center;" th:if="${error}!=null" th:text="${error}">Internal Server Error</div>
					<div class="" id="ajaxError" style="text-align: center;"></div>
					<h4>Verify your account</h4>
					<p class="text-muted">Verification code has been sent to your registered email address with a validity of 15 minutes only<br />
					<p th:text="${userEmail}" hidden="true" id="userEmail">sanjeev@skinternational.com</p>
					</p>

					<form class="container-fuild" id="needs-validation" method="get" novalidate th:action="@{/login/forgotPassword/verifyCode/submit}">
						<div class="row">
							<div class="col-md-12 col-sm-12 col-12">
								<div class="form-group">
									<label class="form-label" for="code"></label>
									<input type="text" class="form-control" name="securityCode" id="code" placeholder="Enter Code"
										required="required" maxlength="6" pattern="[0-9]{6}" >
									<input type="hidden" name="hiddenEmail" id="hiddenEmail" th:value="${userEmail}" autocomplete="off">
									<div class="invalid-feedback">
										Please enter valid code.
									</div>
									<br>
									<div id="resendDiv" th:if="${account_locked!='true'}">
										<button class="text-primary otp-timer" 
										style="background: none!important;border:none;padding:0!important;
											cursor: pointer;font-weight: bold; color: #007bff !important; outline: none;" onclick="resendOtp()">Resend Code
										</button>
									</div>
									<div>
										<small style="font-weight: bold;">
											<p id="otp-sent-msg" style="font-weight: bold;display: inline; color: green !important;"></p>
										</small>
									</div>
<!--									<div>-->
<!--										<small style="font-weight: bold; color:gray; cursor: pointer;" onclick="resendOtp()">-->
<!--											<p class="otp-timer" style="font-weight: bold;display: inline;"></p>-->
<!--										</small>-->
<!--									</div>-->
								</div>
							</div>
						</div>
						<div class="row">
							<input type="hidden" th:value="${#ctx.session.otp_expire_time}" id="otp_expire_time" name="otp_expire_time" />
							<input type="hidden" th:value="${#ctx.session.otp_id}" id="otp_id" name="otp_id" />	
							<div class="col-lg-12 col-sm-12 col-12 text-center" th:if="${account_locked!='true'}">
								<button class="btn btn-primary w-100 reg" id="submitBtn" style="width:100%;"
									type="submit">Validate</button>
							</div>
						</div>
					</form>

				</div>
			</div>
		</div>
	</div>
	<div class="auth_right full_img"></div>
	</div>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script th:src="@{/assets/bundles/lib.vendor.bundle.js}"></script>
	<script th:src="@{/assets/js/core.js}"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js"></script>
	<script id="rendered-js">
		(function () {
			'use strict';
			window.addEventListener('load', function () {
				var form = document.getElementById('needs-validation');
				form.addEventListener('submit', function (event) {
					if (form.checkValidity() === false) {
						event.preventDefault();
						event.stopPropagation();
					}
					form.classList.add('was-validated');
				}, false);
			}, false);
		})();

		// Global variable for timer
		var timer = 60;
		var timerInterval;
		var isBtnDisable = false;

		function startOtpTimer() {
			if (timer >= 0) {
				$(".otp-timer").css("color", "gray");
				//$(".otp-timer").text("Resend Code in " + timer + "s");
				$(".otp-timer").text("Resend Code");
				timer = timer - 1;
			}
			if (timer < 0) {
				$(".otp-timer").css("color", "#0d6efd");
				$(".otp-timer").text("Resend Code");
				clearInterval(timerInterval);
			}
		}

		function getContextPath() {
			return window.location.pathname.substring(0, window.location.pathname.indexOf("/", 2));
		}

		function hideShowResendBtn(hideBtn) {
			if(hideBtn) {
				$(".otp-timer").attr("disabled",true);
			} else {
				$(".otp-timer").removeAttr("disabled");
			}
		}

		function resendOtp() {
			hideShowResendBtn(true);
			triggerOtp();
		}
		
		function checkOtpExpired() {
			const dateTime = luxon.DateTime;
			const currDateTime = dateTime.local().toFormat("yyyy-MM-dd HH:mm:ss.S").replace(' ',"T");
			const otpExpireTime = $("#otp_expire_time").val();
			if(currDateTime > otpExpireTime) {
				//$("#otp-sent-msg").hide();
				$(".otp-timer").show();
				$("#otp-sent-msg").hide();
				showResendLbl();
			} else {
				$(".otp-timer").hide();
			}
		}

		function setSuccessMsg(msg) {
			$("#otp-sent-msg").text(msg);
		}

		function hideResendLbl() {
			$("#resendDiv").hide();
		}
		
		function showResendLbl() {
			$("#resendDiv").show();
		}

		function triggerOtp() {
			let contextPath = getContextPath();
			let otpReqPath = "login/verifyCode/rest";
			
			$.ajax({
				url: contextPath+ "/" + otpReqPath,
				async : false,
				data : {
					"otp_id" : $("#otp_id").val(),
					"hiddenEmail" : $("#hiddenEmail").val()
				},
				success: function (res) {
					console.log(res);
					$("#otp_expire_time").val(res.objData.otp_expire_time);
					$("#otp_expire_time").show();
					setSuccessMsg("Security Code has been sent successfully");
					hideShowResendBtn(false);
					$("#otp-sent-msg").css("display", "inline");
					$("#ajaxError").removeClass("alert alert-danger");
					$("#ajaxError").text("");
					$("#otp_id").val(res.objData.otp_id);
				}, 
				error: function (err) {
					//console.log(err);
					//console.log(err.responseJSON.objData.error);
					const errResp = err;
					$("#ajaxError").text(err.responseJSON.objData.error);
					$("#ajaxError").addClass("alert alert-danger");
					$("#error_lbl").remove();
					$(".otp-sent-msg").text("");
					$(".otp-timer").text("");
					$(".otp-timer").hide();
					$("#submitBtn").attr("disabled", true);
					$("#serverError").hide();
					clearInterval(timerInterval);
				}
			});
		}		

		$(document).ready(function () {
			hideResendLbl();
			timerInterval = setInterval(checkOtpExpired, 1000);
			sessionStorage.setItem("userEmail", $("#userEmail").text());
		});

	</script>

</body>

</html>